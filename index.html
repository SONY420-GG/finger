<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Attendance | Pro Dashboard</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Kanit:wght@300;400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Styles -->
<style>
:root {
    --primary: #6366f1; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; 
    --dark: #1e293b; --bg: #f8fafc;
}
body { font-family: 'Poppins','Kanit',sans-serif; margin:0; display:flex; height:100vh; overflow:hidden; background:var(--bg); }

.sidebar { width:280px; background:var(--dark); color:white; display:flex; flex-direction:column; flex-shrink:0; }
.sidebar-brand { padding:30px; font-size:22px; font-weight:bold; color:var(--success); text-align:center; border-bottom:1px solid rgba(255,255,255,0.1); }
.nav-item { padding:15px 25px; cursor:pointer; display:flex; align-items:center; gap:15px; color:#94a3b8; transition:0.3s; border-left:4px solid transparent; }
.nav-item.active, .nav-item:hover { background: rgba(255,255,255,0.05); color:white; border-left-color: var(--success); }

.main { flex:1; display:flex; flex-direction:column; overflow-y:auto; }
header { background:white; padding:15px 40px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 10px rgba(0,0,0,0.05); }

.status-badge { display:flex; align-items:center; gap:10px; font-weight:bold; padding:8px 18px; border-radius:50px; background:#f1f5f9; font-size:14px; }
.dot { width:12px; height:12px; border-radius:50%; background:#ccc; display:inline-block; }
.dot.online { background:var(--success); box-shadow:0 0 10px var(--success);}
.dot.offline { background:var(--danger); box-shadow:0 0 10px var(--danger); }

.container { padding:30px; max-width:1100px; margin:auto; }
.card { background:white; padding:25px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05); margin-bottom:25px; }

.lcd-display { background:#022c22; color:#5eead4; padding:30px; border-radius:15px; border:6px solid #1e293b; text-align:center; font-family:'Courier New', monospace; font-size:28px; text-transform:uppercase; letter-spacing:2px; min-height:40px; }
.lcd-label { font-size:11px; font-weight:bold; color:#64748b; margin-bottom:8px; text-transform:uppercase; }

.tab-content { display:none; }
.tab-content.active { display:block; }

input { width:100%; padding:12px; border-radius:12px; border:1.5px solid #e2e8f0; margin-bottom:10px; font-size:15px; box-sizing:border-box; }
.btn { padding:12px 18px; border-radius:12px; border:none; font-weight:bold; cursor:pointer; color:white; transition:0.3s; margin-top:10px; display:flex; align-items:center; justify-content:center; gap:10px; }
.btn-primary { background:var(--primary); }
.btn-success { background:var(--success); }
.btn-danger { background:var(--danger); }
.btn-google { background:#000; }
.btn:hover { filter:brightness(1.1); }

table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { padding:12px; border-bottom:1px solid #eee; text-align:left; font-size:14px; }

#toast { position:fixed; bottom:20px; right:20px; background:#333; color:white; padding:15px 25px; border-radius:10px; display:none; z-index:1000; }
</style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar">
    <div class="sidebar-brand"><i class="fas fa-fingerprint"></i> FINGER CLOUD</div>
    <div class="nav-item active" onclick="switchTab('dashboard',this)"><i class="fas fa-desktop"></i> Monitoring</div>
    <div class="nav-item" onclick="switchTab('enroll',this)"><i class="fas fa-user-plus"></i> Register Student</div>
    <div class="nav-item" onclick="switchTab('change',this)"><i class="fas fa-sync-alt"></i> Change Fingerprint</div>
    <div class="nav-item" onclick="switchTab('summary',this)"><i class="fas fa-chart-pie"></i> Summary Report</div>
    <div class="nav-item" onclick="switchTab('settings',this)"><i class="fas fa-cog"></i> Settings</div>
</aside>

<!-- Main -->
<main class="main">
<header>
    <h2 id="tab-title">Monitoring</h2>
    <div class="status-badge">
        <div id="conn-dot" class="dot"></div>
        <span id="conn-text">CHECKING...</span>
    </div>
</header>

<div class="container">
    <!-- LCD Display -->
    <div class="card">
        <div class="lcd-label">Live Device Status</div>
        <div class="lcd-display" id="lcd-text">INITIALIZING...</div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="tab-content active">
        <div class="card">
            <h3>Recent Attendance Logs</h3>
            <table>
                <thead><tr><th>Date</th><th>Name</th><th>Time In</th><th>Time Out</th><th>Status</th></tr></thead>
                <tbody id="log-body"></tbody>
            </table>
            <button class="btn btn-primary" onclick="exportPDF()">Export PDF</button>
            <button class="btn btn-success" onclick="exportExcel()">Export Excel</button>
        </div>
    </div>

    <!-- Enroll -->
    <div id="enroll" class="tab-content">
        <div class="card">
            <h3>Register New User</h3>
            <input type="number" id="reg-id" placeholder="Assigned ID (1-127)">
            <input type="text" id="reg-name" placeholder="Student Name">
            <button class="btn btn-primary" onclick="sendCmd('enroll')">START ENROLLMENT</button>

            <hr style="margin:25px 0; border-top:1px solid #eee;">
            <h3 style="color:var(--danger)">Danger Zone</h3>
            <input type="number" id="del-id" placeholder="Enter ID to Delete">
            <button class="btn btn-danger" onclick="sendCmd('delete')">DELETE PERMANENTLY</button>
        </div>
    </div>

    <!-- Change Fingerprint -->
    <div id="change" class="tab-content">
        <div class="card">
            <h3>Change Fingerprint</h3>
            <p style="color:#666;font-size:13px;">Re-scan fingerprint for existing ID</p>
            <input type="number" id="chg-id" placeholder="Existing User ID">
            <button class="btn btn-success" onclick="sendCmd('change')">RE-SCAN FINGERPRINT</button>
        </div>
    </div>

    <!-- Summary -->
    <div id="summary" class="tab-content">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Attendance Summary</h3>
            </div>
            <table>
                <thead><tr><th>Name</th><th>Total</th><th>Late</th><th>Absent</th><th>Eligibility</th></tr></thead>
                <tbody id="summary-body"></tbody>
            </table>
            <div style="margin-top:15px;">
                <button class="btn btn-primary" onclick="exportSummaryPDF()">Export PDF</button>
                <button class="btn btn-success" onclick="exportSummaryExcel()">Export Excel</button>
            </div>
        </div>
    </div>

    <!-- Settings -->
    <div id="settings" class="tab-content">
        <div class="card">
            <h3>Device Configuration</h3>
            <label>Late Threshold</label>
            <input type="time" id="t-late" value="08:45">
            <label>Checkout Threshold</label>
            <input type="time" id="t-out" value="11:30">
            <button class="btn btn-primary" onclick="saveSettings()">UPDATE DEVICE TIME</button>
        </div>
    </div>
</div>
</main>

<div id="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- jsPDF & SheetJS for PDF/Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const firebaseConfig = { databaseURL:"https://fingerclass-34d34-default-rtdb.asia-southeast1.firebasedatabase.app" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let users={}, logs={};

function switchTab(id,el){
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    el.classList.add('active');
    document.getElementById('tab-title').innerText = el.innerText;
}

function showToast(msg){
    const t=document.getElementById('toast');
    t.innerText=msg; t.style.display='block';
    setTimeout(()=>t.style.display='none',3000);
}

// Firebase Listeners
db.ref('system/heartbeat').on('value', snap=>{
    const dot=document.getElementById('conn-dot');
    const text=document.getElementById('conn-text');
    dot.className="dot online"; text.innerText="DEVICE ONLINE";
    clearTimeout(window.offT);
    window.offT=setTimeout(()=>{
        dot.className="dot offline"; text.innerText="DEVICE OFFLINE";
        document.getElementById('lcd-text').innerText="OFFLINE";
    },15000);
});

db.ref('control_panel/status').on('value', snap=>{
    if(document.getElementById('conn-text').innerText!=="DEVICE OFFLINE"){
        document.getElementById('lcd-text').innerText = snap.val() || "READY";
        document.getElementById('lcd-text').style.color="#5eead4";
    }
});

db.ref('users').on('value', snap=>{ users = snap.val()||{}; updateSummary(); });
db.ref('finger_log').on('value', snap=>{ logs = snap.val()||{}; renderLogs(); updateSummary(); });

// Render Functions
function renderLogs(){
    const tbody=document.getElementById('log-body'); tbody.innerHTML="";
    for(let id in logs){
        for(let date in logs[id]){
            const l=logs[id][date];
            tbody.innerHTML += `<tr>
                <td>${date}</td>
                <td>${users[id]||id}</td>
                <td>${l.check_in||'-'}</td>
                <td>${l.check_out||'-'}</td>
                <td class="${l.status==='LATE'?'status-late':'status-ok'}">${l.status||'OK'}</td>
            </tr>`;
        }
    }
}

function updateSummary(){
    const tbody=document.getElementById('summary-body'); tbody.innerHTML="";
    const workDays=22;
    for(let id in users){
        let present=0, late=0;
        if(logs[id]){
            present=Object.keys(logs[id]).length;
            for(let d in logs[id]) if(logs[id][d].status==="LATE") late++;
        }
        let eli = late>=4 ? "INELIGIBLE" : "ELIGIBLE";
        tbody.innerHTML += `<tr>
            <td><b>${users[id]}</b></td>
            <td>${present}</td>
            <td>${late}</td>
            <td>${workDays-present}</td>
            <td>${eli}</td>
        </tr>`;
    }
}

// Commands
function sendCmd(type){
    let payload={ command:type, timestamp:Date.now() };
    if(type==='enroll'){ payload.target_id=parseInt(document.getElementById('reg-id').value); payload.target_name=document.getElementById('reg-name').value; }
    else if(type==='delete'){ payload.target_id=parseInt(document.getElementById('del-id').value); }
    else if(type==='change'){ payload.command="enroll"; payload.target_id=parseInt(document.getElementById('chg-id').value); payload.target_name=users[payload.target_id]||"User"; }

    if(!payload.target_id) return alert("Please enter ID");
    db.ref('control_panel').set(payload);
    showToast("Command Sent!");
}

// Settings
function saveSettings(){
    db.ref('settings').update({
        late_threshold:parseInt(document.getElementById('t-late').value.replace(":","")),
        checkout_threshold:parseInt(document.getElementById('t-out').value.replace(":",""))
    });
    db.ref('control_panel/command').set('sync_time');
    showToast("Settings Saved");
}

// PDF & Excel Export
function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let rows=[];
    for(let id in logs){
        for(let date in logs[id]){
            const l=logs[id][date];
            rows.push([date, users[id]||id, l.check_in||'-', l.check_out||'-', l.status||'OK']);
        }
    }
    doc.autoTable({ head:[['Date','Name','Time In','Time Out','Status']], body:rows });
    doc.save('Attendance.pdf');
}

function exportExcel(){
    let wb=XLSX.utils.book_new();
    let ws_data=[['Date','Name','Time In','Time Out','Status']];
    for(let id in logs){
        for(let date in logs[id]){
            const l=logs[id][date];
            ws_data.push([date, users[id]||id, l.check_in||'-', l.check_out||'-', l.status||'OK']);
        }
    }
    let ws=XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Attendance");
    XLSX.writeFile(wb, "Attendance.xlsx");
}

// PDF & Excel Export for Summary
function exportSummaryPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let rows=[];
    const tbody=document.getElementById('summary-body');
    for(let tr of tbody.querySelectorAll('tr')){
        let row=[];
        for(let td of tr.querySelectorAll('td')){
            row.push(td.innerText);
        }
        rows.push(row);
    }
    doc.autoTable({ head:[['Name','Total','Late','Absent','Eligibility']], body:rows });
    doc.save('Attendance_Summary.pdf');
}

function exportSummaryExcel(){
    let wb=XLSX.utils.book_new();
    let ws_data=[['Name','Total','Late','Absent','Eligibility']];
    const tbody=document.getElementById('summary-body');
    for(let tr of tbody.querySelectorAll('tr')){
        let row=[];
        for(let td of tr.querySelectorAll('td')){
            row.push(td.innerText);
        }
        ws_data.push(row);
    }
    let ws=XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Summary");
    XLSX.writeFile(wb, "Attendance_Summary.xlsx");
}
</script>
</body>
</html>
